# shellcheck disable
name: bump risingwave
on:
  workflow_dispatch:
    inputs:
      version:
        description: "Override RisingWave version (e.g. 2.5.1). Leave empty to use latest stable release."
        required: false
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  bump:
    runs-on: ubuntu-latest
    env:
      HOMEBREW_NO_INSTALL_FROM_API: 1 # https://github.com/Homebrew/brew/issues/15049
      HOMEBREW_GITHUB_API_TOKEN: ${{ secrets.HOMEBREW_BUMP_PR_TOKEN }}
      GH_TOKEN: ${{ secrets.HOMEBREW_BUMP_PR_TOKEN }}
      GITHUB_TOKEN: ${{ secrets.HOMEBREW_BUMP_PR_TOKEN }}
      TAP: ${{ github.repository_owner }}/risingwave
    steps:
      - name: Set up Homebrew
        uses: Homebrew/actions/setup-homebrew@master

      - name: Set up git
        uses: Homebrew/actions/git-user-config@master

      - name: Resolve target version
        id: resolve
        shell: bash
        run: |
          set -euo pipefail

          if [[ -n "${{ inputs.version }}" ]]; then
            version="${{ inputs.version }}"
            tag="v${version#v}"
          else
            tag="$(gh api repos/risingwavelabs/risingwave/releases/latest --jq .tag_name)"
            version="${tag#v}"
          fi

          echo "tag=$tag" >>"$GITHUB_OUTPUT"
          echo "version=$version" >>"$GITHUB_OUTPUT"
          echo "Resolved version: $version ($tag)"

      - name: Bump formula and connector resource
        shell: bash
        env:
          RW_TAG: ${{ steps.resolve.outputs.tag }}
          RW_VERSION: ${{ steps.resolve.outputs.version }}
        run: |
          set -euo pipefail

          brew tap "$TAP"
          tap_dir="$(brew --repo "$TAP")"
          formula_path="$tap_dir/Formula/risingwave.rb"

          # shellcheck disable=SC2016 # $1 is for Ruby regex capture, not shell expansion.
          current_tag="$(ruby -ne 'if $_ =~ %r{^\\s*url\\s+\"https://github\\.com/risingwavelabs/risingwave/archive/refs/tags/(v[^\\\"]+)\\.tar\\.gz\"\\s*$}; puts $1; exit; end' "$formula_path" || true)"
          if [[ -n "$current_tag" && "$current_tag" == "$RW_TAG" ]]; then
            echo "Formula already at latest ($current_tag); nothing to do."
            exit 0
          fi

          cd "$tap_dir"

          base_branch="bump-risingwave-$RW_VERSION"
          suffix="${GITHUB_RUN_ID:-$(date +%s)}"
          branch="${base_branch}-${suffix}"

          git fetch origin main
          git checkout -B "$branch" origin/main

          # Bump the main formula (as in README), but don't open a PR yet.
          brew bump-formula-pr --write-only --commit --no-audit "$TAP/risingwave" --version "$RW_VERSION"

          connector_url="https://github.com/risingwavelabs/risingwave/releases/download/$RW_TAG/risingwave-connector-$RW_TAG.tar.gz"
          echo "Connector URL: $connector_url"

          tmp="$(mktemp -d)"
          trap 'rm -rf "$tmp"' EXIT
          curl -fsSL "$connector_url" -o "$tmp/connector.tgz"
          # shellcheck disable=SC2016 # $1 is for awk field, not shell expansion.
          connector_sha="$(sha256sum "$tmp/connector.tgz" | awk '{print $1}')"
          echo "Connector sha256: $connector_sha"

          FORMULA_PATH="$formula_path" CONNECTOR_URL="$connector_url" CONNECTOR_SHA256="$connector_sha" ruby -e '
            path = ENV.fetch("FORMULA_PATH")
            new_url = ENV.fetch("CONNECTOR_URL")
            new_sha = ENV.fetch("CONNECTOR_SHA256")

            lines = File.readlines(path, chomp: true)
            in_block = false
            saw_block = false
            updated_url = false
            updated_sha = false

            out = lines.map do |line|
              if line.match?(/^\s*resource\s+\"connector\"\s+do\s*$/)
                in_block = true
                saw_block = true
                next line
              end

              if in_block && line.match?(/^\s*url\s+\".*\"\s*$/)
                updated_url = true
                next line.sub(/\".*\"/, "\"#{new_url}\"")
              end

              if in_block && line.match?(/^\s*sha256\s+\".*\"\s*$/)
                updated_sha = true
                next line.sub(/\".*\"/, "\"#{new_sha}\"")
              end

              if in_block && line.match?(/^\s*end\s*$/)
                in_block = false
                next line
              end

              line
            end

            raise "resource \\\"connector\\\" block not found" unless saw_block
            raise "connector url not updated" unless updated_url
            raise "connector sha256 not updated" unless updated_sha

            File.write(path, out.join("\n") + "\n")
          '

          git add "$formula_path"
          git commit -m "risingwave: update connector resource to $RW_VERSION" || true

          # Ensure we can push with GITHUB_TOKEN.
          git remote set-url origin "https://x-access-token:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git"
          git push -u origin "$branch"

          existing_url="$(gh pr list --repo "$GITHUB_REPOSITORY" --head "$branch" --state all --json url --jq '.[0].url' || true)"
          if [[ -n "$existing_url" && "$existing_url" != "null" ]]; then
            echo "$existing_url"
            exit 0
          fi

          pr_url="$(gh pr create \
            --repo "$GITHUB_REPOSITORY" \
            --base main \
            --head "$branch" \
            --title "risingwave $RW_VERSION" \
            --body "Bump risingwave to $RW_VERSION and update the connector resource.")"

          pr_number="$(gh pr list --repo "$GITHUB_REPOSITORY" --head "$branch" --state open --json number --jq '.[0].number')"

          old_pr_numbers="$(gh pr list --repo "$GITHUB_REPOSITORY" --state open --json number,headRefName --jq ".[] | select(.headRefName != \"${branch}\" and (.headRefName | startswith(\"${base_branch}\"))) | .number" || true)"
          if [[ -n "$old_pr_numbers" ]]; then
            echo "$old_pr_numbers" | while read -r n; do
              [[ -z "$n" ]] && continue
              echo "Closing old PR: #$n"
              gh pr close --repo "$GITHUB_REPOSITORY" "$n" --comment "Superseded by #$pr_number."
            done
          fi

          echo "$pr_url"
